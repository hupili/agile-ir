# Add PDF Bookmarks

## Tools 

   * pdftohtml
   * gs
   * grep
   * awk
   * sed
   * xargs, "--arg-file="

## Question

I come across a good survey paper: 
[Graphical Models, Exponential Families, and Variational Inference](http://scholar.google.com/scholar?hl=en&q=Graphical+Models%2C+Exponential+Families%2C+and+Variational+Inference).

Soon after opening it, you'll realize the problem:
there is no Table-Of-Content; 
there is no pdf bookmark. 

T-H-R-E-E H-U-N-D-R-E-D P-A-G-E-S W-I-T-H-O-U-T T-A-B-L-E O-F C-O-N-T-E-N-T-S!!

In this case, we are going to extract proper headers from the pdf documents, 
insert the TOC as bookmark of the PDF. 

## Procedure

### Get Page Headers

Suppose `origin.pdf` is the original pdf document. 

Convert pdf to html using `pdftohtml origin.pdf my.html`
and examine the output file. 

By looking at the `mys.html` file, 
we conclude that "A name=xxx" is a pattern for page headers. 
We first try `grep "name=" mys.html`:

```
   ... (more omitted) ...
<A name=191></a>7.5&#160;Convex&#160;Surrogates&#160;in&#160;Parameter&#160;Estimation<br/>
<A name=192></a>192<br/>
<A name=193></a>7.5&#160;Convex&#160;Surrogates&#160;in&#160;Parameter&#160;Estimation<br/>
<A name=194></a>194<br/>
<A name=195></a>8<br/>
<A name=196></a>196<br/>
   ... (more omitted) ...
```

We are almost there. 
Those are page numbers with section headings. 
Next is to organize them into some clean format. 
Note that there are some html entities. 
You can verify the only instance is `&#160` by 
`grep "name=" mys.html | grep -o "&#..." | sort -u`. 
So we do not bother to invoke sophisticated HTML entity unescaping libraries. 
Instead, we do simple 
[substitution](http://www.w3schools.com/html/html_entities.asp). 

The final one-liner to make a well-structured header list 
(for this particular paper) is:

```
grep "name=" mys.html | sed -e 's/&#160;/ /g' -e 's/<A name=//g' -e 's/><\/a>/\t/g' -e 's/<br\/>//g' | grep -v "<IMG" | awk '{OFS="\t";if($1>=3 && $1!=$2){print $0}}' |uniq -f1 > page-header.txt
```

I won't go through them in details because the full 
agile-ir repo is discussing them from all aspects. 
Here is a list of short description and 
one can figure out the function of each section by 
examining the intermediate result in the pipe:

   * Unescape the 'blank' HTML entity; chop off HTML tags. 
   * Ignore those image tags, which also has a corresponding `<A name=xxx>` but is not header. 
   * Ignore even pages, who do not have header text (only page number); 
   Ignore pages with number smaller than 3 
   (1st section "introduction starts at 3 and there are unwanted text before that).
   * Unique the 2nd column (header text) so as to only leave the 
   1st occurrences of the page number. 

### Insert Bookmarks

With this structured list, we can then build bookmark commands:

```
awk -F'\\t' '{printf("-c \"[/Page %d /View [/XYZ null null null] /Title (%s) /OUT pdfmark\"\n",$1,$2)}' page-header.txt > page-header.cmd
```

We simply use `awk` to fill in the command template. 
I excerpt 
[the description](http://stackoverflow.com/a/3108884/1772926)
here for your convenience:

> `[/Page 1 /View [/XYZ null null null] /Title (File 1) /OUT pdfmark`
> The `[/XYZ null null null]` 
> part makes sure your page viewport and zoom level does not change from the current one when you follow the link. 
> (You could say `[/XYZ 222 111 2]` to do this, if you want an arbitrary example.)
> The `/Title (some string you want)` thingie determines what text is in the ToC.

```
xargs --arg-file=page-header.cmd gs -dBATCH -dNOPAUSE -sDEVICE=pdfwrite -sOutputFile=bm.pdf -f origin.pdf
```

`gs -dBATCH -dNOPAUSE -sDEVICE=pdfwrite -sOutputFile=bm.pdf -f origin.pdf -c xxx -c xxx` 
is the GhostScript command and we use xargs to fill in those "-c" parameters. 

## Remarks

   * One can also use `/Count` attribute in gs to 
   make the bookmarks nested. See 
   [this page](http://blog.tremily.us/posts/PDF_bookmarks_with_Ghostscript/).
   You are very welcome to add this section and make a pull request,
   which will definitely help others. 
   * Commands in this article may only work for this particular paper. 
   agile-ir focus more on methodology instead of off-the-shelf tools. 
   I think you can adapt it to many other documents. 
   You are not recommended to run the commands directly. 
   Instead, you'd better try to understand them by part first 
   and run the sections incrementally.
   At the mean time, watch carefully what happened with each section of command. 
   * The shouting at the beginning of the page is generated by the line
   `echo -n "three hundred pages without table of contents" | sed 's/\(.\)/\1\n/g' | tr '[:lower:]' '[:upper:]' | sed 's/^\s*$/+/g' | xargs -i echo '_{}' | xargs echo | sed -e 's/ //g' -e 's/_+_/ /g' -e 's/_/-/g'`, 
   with the help of 
   [sed](http://www.commandlinefu.com/commands/view/1358/print-text-string-vertically-one-character-per-line.),
   [tr](http://www.cyberciti.biz/faq/linux-unix-shell-programming-converting-lowercase-uppercase/).

## Reference

   * Discussion, many pointers: 
   [http://stackoverflow.com/questions/2969479/merge-pdfs-with-pdftk-with-bookmarks](http://stackoverflow.com/questions/2969479/merge-pdfs-with-pdftk-with-bookmarks)
   * Discussion, many pointers:
   [http://unix.stackexchange.com/questions/17065/add-and-edit-bookmarks-to-pdf](http://unix.stackexchange.com/questions/17065/add-and-edit-bookmarks-to-pdf)
   * Tutorial of iText, but it is no longer "agile" 
   as is expected in this project. 
   [http://www.geek-tutorials.com/java/itext/itext_bookmark_anchor.php](http://www.geek-tutorials.com/java/itext/itext_bookmark_anchor.php)
   * A 
   [tutorial](http://www.freewaregenius.com/how-to-add-bookmarks-to-a-pdf-document-using-free-software/)
   using 
   [JPdfBookmarks](http://sourceforge.net/projects/jpdfbookmarks/).
   It is GUI based. 
   I don't know whether it can be used to do scripting or not. 
   The backend is iText. 
   * A general
   [tutorial](http://www.linux.com/learn/tutorials/442414-manipulating-pdfs-with-the-pdf-toolkit)
   for "pdftk", 
   not for the bookmark manipulation we concern. 
   * Adobe's pdfmark reference:
   [http://www.adobe.com/content/dam/Adobe/en/devnet/acrobat/pdfs/pdfmark_reference.pdf](http://www.adobe.com/content/dam/Adobe/en/devnet/acrobat/pdfs/pdfmark_reference.pdf)
